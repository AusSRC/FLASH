<!DOCTYPE html>
<html>
<head>
    <title>FLASHDB</title>
    <style>
    .border {
        border: 2px solid black;
        padding: 4px;
    }
    .column {
        flex: 1; /* Allows columns to grow and shrink equally */
        /* You can add other styling here, e.g., background-color, padding */
    }
    .legend-list {
        list-style-type: none;
        padding: 0;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-color-box {
        width: 20px;
        height: 20px;
        margin-right: 10px;
    }
    </style>
    <!-- our code needs jQuery library -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js" charset="utf-8"></script>
    <!-- Aladin Lite JS code -->
    <script type="text/javascript" src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>
</head>
<body style="background-color:#ABB2B9;">
  {{ sbids|json_script:"sbids-data" }}  
  <div class="container-fluid border" style="background-color:aquamarine;">
    <H1 style="text-align: center;">FLASH Survey Progress</H1>
    {% load static %}
    <div class="container border" style="display:flex; gap:20px; border:none;">
      <img src="{% static 'db_query/SKAO_ausSRC_logo_colour_white_bg.png' %}" alt="AusSRC" style="top:20px; right:30px;" width="200" height="100">          
      <!-- Create a legend for the type of detections -->  
      <div class="column border" id="myLegendContainer">
        <ul class="legend-list">
          <li class="legend-item"><span class="legend-color-box" style="background-color: green;"></span>MASKED DETECTION</li>
          <li class="legend-item"><span class="legend-color-box" style="background-color: yellow;"></span>INVERTED DETECTION</li>
          <li class="legend-item"><span class="legend-color-box" style="background-color: blue;"></span>STANDARD DETECTION</li>
          <li class="legend-item"><span class="legend-color-box" style="background-color: grey;"></span>NO DETECTION</li>            
        </ul>      
      </div>      
      <div class='column border' id='run_summary'></div>
      <div class='column border' id='status_summary'>
        <br>GOOD observations = {{ num_good }}
        <br>UNCERTAIN observations = {{ num_uncertain }}
        <br>REJECTED observations = {{ num_rejected }}
        <br>NOT VALIDATED = {{ num_not_validated }}
      </div>	  
      <img src="{% static 'db_query/flash.jpeg' %}" alt="FLASH" style="top:20px; left:30px;" width="180" height="100">
    </div>   
    <p id='total_sbids' style="text-align: center;">Total number of SBIDs shown = {{num_sbids}}</p> 
    <form action="/db_query/">
      <input type="hidden" id="session_id" name="session_id" value={{ session_id }}/>
      <input type="submit" value="Return to Main page"/>
    </form>
  </div>
  <div class="container-fluid border">
     <!-- Aladin Lite container at requested dimensions -->
     <div id="aladin-lite-div" style="width:1000px;height:700px;"></div>
  </div>
  <!-- Creation of Aladin Lite instance with initial parameters -->
  <script type="text/javascript"> 
    let aladin;
    let tiles = JSON.parse(document.getElementById('sbids-data').textContent);
    A.init.then(() => {
      // set up aladin
      aladin = A.aladin('#aladin-lite-div', {survey: "P/DSS2/color", fov: 1.5, target: "trifid nebula"});

      // create catalogs for status
      var goodCat = A.catalog({name: 'Good Observations', shape: 'circle', color: 'cyan', onClick: 'showPopup'});
      aladin.addCatalog(goodCat);
      var uncertainCat = A.catalog({name: 'Uncertain Observations', shape: 'square', color: 'white', onClick: 'showPopup'});
      aladin.addCatalog(uncertainCat);
      var rejectedCat = A.catalog({name: 'Rejected Observations', shape: 'cross', color: 'red', onClick: 'showPopup'});
      aladin.addCatalog(rejectedCat);      
      var notValidatedCat = A.catalog({name: 'Not Validated', shape: 'triangle', color: 'pink', onClick: 'showPopup'});
      aladin.addCatalog(notValidatedCat);
      // create layers based on detection runs 
      var maskedLayer = A.graphicOverlay({name:'Masked Detections', color: 'grey', opacity: 0.5, lineWidth: 1});
      aladin.addOverlay(maskedLayer);
      var invertedLayer = A.graphicOverlay({name:'Inverted Detections', color: 'grey', opacity: 0.5, lineWidth: 1});
      aladin.addOverlay(invertedLayer);
      var standardLayer = A.graphicOverlay({name:'Standard Detections', color: 'grey', opacity: 0.5, lineWidth: 1});
      aladin.addOverlay(standardLayer);
      var noDetectLayer = A.graphicOverlay({name:'No Detections', color: 'grey', opacity: 0.5, lineWidth: 1});
      aladin.addOverlay(noDetectLayer); 
      
      var detection = 0;
      var invert = 0;
      var mask = 0;
      var notDetected = 0;  
      tiles.forEach(sbid => {
        var ra = parseFloat(sbid[3]);
        var dec = parseFloat(sbid[4]);

        // Create catalog sources
        var marker = A.source(ra, dec,
                  {SBID: sbid[0], FIELD: sbid[1], STATUS: sbid[5]});
        switch(sbid[5]) {
            case "GOOD":
                goodCat.addSources([marker]);
                break;
            case "UNCERTAIN":
                uncertainCat.addSources([marker]);
                break;
            case "REJECTED":
                rejectedCat.addSources([marker]);
                break;
            default:
                notValidatedCat.addSources([marker]);
                break;
        }
                  
        // detection shapes
        d_ra_upper = 3.0 / Math.cos((dec + 3.0) * Math.PI / 180.0);
        d_ra_lower = 3.0 / Math.cos((dec - 3.0)* Math.PI / 180.0);
        shape = A.polygon([
                    [ra + d_ra_lower, dec - 3.0],
                    [ra - d_ra_lower, dec - 3.0],
                    [ra - d_ra_upper, dec + 3.0],
                    [ra + d_ra_upper, dec + 3.0]
        ]);
        shape.fill = true;
        shape.opacity = 0.3;
        if (sbid[8] === true) {
          shape.fillColor = 'green';
          maskedLayer.addFootprints([shape]);
          mask++;
        } else if (sbid[7] === true) {
          shape.fillColor = 'yellow';
          invertedLayer.addFootprints([shape]);
          invert++;
        } else if (sbid[6] === true) {
          shape.fillColor = 'blue';
          standardLayer.addFootprints([shape]);
          detection++;
        } else {
          shape.fillColor = 'grey';
          noDetectLayer.addFootprints([shape]);
          notDetected++;
        }               
      });
      document.getElementById('run_summary').innerHTML = "<br>MASKED DETECTION runs  = "+ mask +"<br>INVERTED DETECTION  runs = " + invert 
              + "<br>STANDARD DETECTION runs = " + detection + "<br>NO DETECTION = " + notDetected + "<br>";
    });
  </script>
</body>